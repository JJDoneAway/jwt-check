package main

import (
	"fmt"
	"jwt-check/siam"
	"time"
)

// https://dev-ekwvp-wi.us.auth0.com/.well-known/jwks.json
// https://johannes-address-book-ui.dev.sit.sys.odj.cloud/env
const jwtRaw string = "eyJraWQiOiI5MDk3MDM3OTI2MzI2NjAxMzUxOTgwOTkzNzQwODA3MjEzODkwOCIsInR5cCI6IkpXVCIsImFsZyI6IlJTMjU2In0.eyJpc3MiOiJodHRwczovL2ZlZGVyYXRpb24uYXV0aC5zY2h3YXJ6L25pZHAvb2F1dGgvbmFtIiwianRpIjoiZDkyNzA2NjktNTY5ZS00NTFjLTgwMGItYzY4NzljNzFlOWNkIiwiYXVkIjoiOWRlMGVmYjktNzY3ZS00NTNiLTg0ZmEtYTNiMGQ3NmM5N2JlIiwiZXhwIjoxNjcxNTYzNTE5LCJpYXQiOjE2NzE1NTk5MTksIm5iZiI6MTY3MTU1OTg4OSwic3ViIjoiYzMxZTBlYmMxODhhYWY0NWJiYmFjMzFlMGViYzE4OGEiLCJfcHZ0IjoiMlo5NTByYXczNzkvWTUvZExCbzIybnRoV0V3UWt3UU1ERVNPVGNFN1VPRnUyTFZzM3BxS0lxeWpaUDUxaERjVEVPOXIvQnlUR2c4S2JlTXBuaVBXNFhnZTcrUlFwTmZraXFlREVVWkVTK1FYTnRxL3ZqM1hWcXhadDN3MHFrWW1XclVVZ0RONVo3MVMreTF5QjZoQmlpS2plaTVTRmd4NTVtVmJTMVZjQ1Nod1dpQ284SXNxejk2azF0cmpMWXFNb1Q4dzFucDVCSzBhcmYrU0JiZlZsL3NqYlMrMmxacDdCdVJrRE5Na2VSZUx1ZHZnTkVHdldRWlE2N1RxM05ONXpSNkcwZTFwWEwwdkZjUUc3c01ERTY4RFl4amNKdm91R1kxQ2R3R1NJSHBjOEtuVjFUK3ZMZHFiQ0ZLV3BLOVNidXdCYitscWkxTnExMnEzbnBPV0Q2OXBxaGt5RC9XdUY5RUhwSkdicE1DSGtOdGRsRWlxSHhiZXFWZ0VEa3NtcWtjQ1pqR0xCelpiSTlTSExOakNDdmlPSnVUQTRodHJVQWVwZThNVGtjQllIdFJjNEhCbHlwd0ZOUk5sdzhPUWp1UzhCVndXaXRuQTRlbkhJUkRnRTlDTlJLbjJhbk1qa1B6dEFuY1pLcHVIYzB4d0JZc3pqMDlRMnZtc1c0a0RBZmJFMEd6VmlrbkVmaERPVEVFUVZIaEtrK3Rya3V3azd4NEtiMmhONll1UzhybnY2UHFxWkJaK0N6clphc2gyLjgiLCJzY29wZSI6WyJzaWFtIiwicHJvZmlsZSJdLCJ1aWQiOiJob2VobmVqbyIsIm1haWwiOiJKb2hhbm5lcy5Ib2VobmVAbWFpbC5zY2h3YXJ6IiwiZ2l2ZW5OYW1lIjoiSm9oYW5uZXMiLCJuaWNrbmFtZSI6IjEwMDI0Njk3NjIiLCJmdWxsTmFtZSI6IkpvaGFubmVzIEjDtmhuZSIsIkNsb3VkTG9naW5OYW1lIjoiSm9oYW5uZXMuSG9laG5lQG1haWwuc2Nod2FyeiIsInNuIjoiSMO2aG5lIiwiZ3JvdXBNZW1iZXJzaGlwIjpbImNuPXNpdC1uZXdzLW1lbWJlcixvdT1hcHA0eW91LG91PWFwcHMsbz1nbG9iYWwiLCJjbj1hbGwtc2RsLG91PWFwcDR5b3Usb3U9YXBwcyxvPWdsb2JhbCIsImNuPWFsbC1zemQsb3U9YXBwNHlvdSxvdT1hcHBzLG89Z2xvYmFsIiwiY249c2l0LW1lbWJlcixvdT1hcHA0eW91LG91PWFwcHMsbz1nbG9iYWwiLCJjbj1nZXRzbWFydC1uZy1hcHAtc2JveCxvdT1nZXRzbWFydCxvdT1hcHBzLG89Z2xvYmFsIiwiY249YXJpYmEtaW50LWludGVybixvdT1hcmliYSxvdT1hcHBzLG89Z2xvYmFsIiwiY249YWxsLXNpdCxvdT1hcHA0eW91LG91PWFwcHMsbz1nbG9iYWwiLCJjbj1nZXRzbWFydC1uZy1saWRsLWludC1jb3BlLG91PWdldHNtYXJ0LG91PWFwcHMsbz1nbG9iYWwiLCJjbj1maWxlNHlvdS1pbnQtQWNjZXNzLG91PWZpbGU0eW91LG91PWFwcHMsbz1nbG9iYWwiLCJjbj1vZGotaW50LXNpdC1iY2Qtb2RqLXVzZXIsb3U9b2RqLG91PWFwcHMsbz1nbG9iYWwiLCJjbj1zdGFja2l0LXBvcnRhbC14eC1hY2NvdW50LW1lbWJlcixvdT1zdGFja2l0LXBvcnRhbCxvdT1hcHBzLG89Z2xvYmFsIiwiY249c255ay14eC1zaXQtbWFnaWMtbW9uaXRvcmluZy1hZG0sb3U9c255ayxvdT1hcHBzLG89Z2xvYmFsIiwiY249YXJ0aWZhY3RvcnkteHgtc2l0LW1hZ2ljLW1vbml0b3JpbmctcmRyLG91PWFydGlmYWN0b3J5LG91PWFwcHMsbz1nbG9iYWwiLCJjbj1vZGotaW50LXNpdC1iY2Qtc3ViLXN1Yi1lYW0tZGV2LG91PW9kaixvdT1hcHBzLG89Z2xvYmFsIiwiY249c255ay14eC1zaXQtb2RqLWFwaWVuYWJsZW1lbnQtYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNvbmFycXViZS14eC1zaXQtb2RqLWFwaWVuYWJsZW1lbnQtY29uLG91PXNvbmFycXViZSxvdT1hcHBzLG89Z2xvYmFsIiwiY249YXJ0aWZhY3RvcnkteHgtc2l0LW9kai1hcGllbmFibGVtZW50LWFkbSxvdT1hcnRpZmFjdG9yeSxvdT1hcHBzLG89Z2xvYmFsIiwiY249Z2l0ZWEteHgtdmNzLWFjY2VzcyxvdT1naXRlYSxvdT1hcHBzLG89Z2xvYmFsIiwiY249cHVsc2UtdnBuLWwtaW50LG91PXB1bHNlLG91PWFwcHMsbz1nbG9iYWwiLCJjbj1hcnRpZmFjdG9yeS14eC1zaXQtb2RqLWpvaGFubmVzLW1lZXRzLW9kai1hZG0sb3U9YXJ0aWZhY3Rvcnksb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNueWsteHgtc2l0LW9kai1qb2hhbm5lcy1tZWV0cy1vZGotYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNvbmFycXViZS14eC1zaXQtb2RqLWpvaGFubmVzLW1lZXRzLW9kai1jb24sb3U9c29uYXJxdWJlLG91PWFwcHMsbz1nbG9iYWwiLCJjbj1vZGotaW50LXNpdC1iY2Qtc3ViLXN1Yi1tb25pdG9yaW5nLXNjaHdhcnotZGV2LG91PW9kaixvdT1hcHBzLG89Z2xvYmFsIiwiY249c255ay14eC1zaXQtb2RqLWFsZXJ0aW5nLXNjaHdhcnotYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNvbmFycXViZS14eC1zaXQtb2RqLWFsZXJ0aW5nLXNjaHdhcnotY29uLG91PXNvbmFycXViZSxvdT1hcHBzLG89Z2xvYmFsIiwiY249YXJ0aWZhY3RvcnkteHgtc2l0LW9kai1hbGVydGluZy1zY2h3YXJ6LWFkbSxvdT1hcnRpZmFjdG9yeSxvdT1hcHBzLG89Z2xvYmFsIiwiY249YXJ0aWZhY3RvcnkteHgtc2l0LW1vbml0b3Jpbmctc2Nod2Fyei1hZG0sb3U9YXJ0aWZhY3Rvcnksb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNueWsteHgtc2l0LW9kai1tb25pdG9yaW5nLXNjaHdhcnotYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNueWsteHgtc2l0LW9kai1tb25pdG9yaW5nLXNjaHdhcnotY29uLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNueWsteHgtc2l0LW9kai1lYW0tYmFzaWMtYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNvbmFycXViZS14eC1zaXQtb2RqLXRlc3R0bDEyMzQtY29uLG91PXNvbmFycXViZSxvdT1hcHBzLG89Z2xvYmFsIiwiY249c255ay14eC1zaXQtb2RqLWNvbnRhY3R1aTA4MTUtYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNueWsteHgtc2l0LW9kai1lYW0tYXotYS1hZG0sb3U9c255ayxvdT1hcHBzLG89Z2xvYmFsIiwiY249c29uYXJxdWJlLXh4LXNpdC1vZGotY29udGFjdHVpMDgxNS1jb24sb3U9c29uYXJxdWJlLG91PWFwcHMsbz1nbG9iYWwiLCJjbj1zb25hcnF1YmUteHgtc2l0LW9kai1lYW0tYmFzaWMtY29uLG91PXNvbmFycXViZSxvdT1hcHBzLG89Z2xvYmFsIiwiY249c255ay14eC1zaXQtb2RqLXRlc3R0bDEyMzQtYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPXNvbmFycXViZS14eC1zaXQtb2RqLW1vbml0b3Jpbmctc2Nod2Fyei1jb24sb3U9c29uYXJxdWJlLG91PWFwcHMsbz1nbG9iYWwiLCJjbj1zbnlrLXh4LXNpdC1vZGotYWRkcmVzc2Jvb2twYXNjYWwtYWRtLG91PXNueWssb3U9YXBwcyxvPWdsb2JhbCIsImNuPWFydGlmYWN0b3J5LXh4LXNpdC1hZGRyZXNzYm9va3Bhc2NhbC1hZG0sb3U9YXJ0aWZhY3Rvcnksb3U9YXBwcyxvPWdsb2JhbCIsImNuPWFydGlmYWN0b3J5LXh4LXNpdC1jbG91ZHN1cnZleXMtYWRtLG91PWFydGlmYWN0b3J5LG91PWFwcHMsbz1nbG9iYWwiLCJjbj1zbnlrLXh4LXNpdC1vZGotY2xvdWRzdXJ2ZXlzLWFkbSxvdT1zbnlrLG91PWFwcHMsbz1nbG9iYWwiLCJjbj1zb25hcnF1YmUteHgtc2l0LW9kai1jbG91ZHN1cnZleXMtY29uLG91PXNvbmFycXViZSxvdT1hcHBzLG89Z2xvYmFsIiwiY249Y29tbWNhcnMteHgtZHdrLWtvbmZpZ3VyaWVyZXItZmU0LG91PWNvbW1jYXJzLG91PWFwcHMsbz1nbG9iYWwiLCJjbj1lZnMteHgtbmV0ZHJpdmUtYWRzLXNjaHdhcnotbyxvdT1lZnMsb3U9YXBwcyxvPWdsb2JhbCIsImNuPWFwcDR5b3Utb25laXRmay1tZW1iZXIsb3U9YXBwNHlvdSxvdT1hcHBzLG89Z2xvYmFsIl0sImtsQ2xvdWRMb2dpbk5hbWUiOiJKb2hhbm5lcy5Ib2VobmVAbWFpbC5zY2h3YXJ6Iiwid29ya2ZvcmNlSUQiOiIxMDAyNDY5NzYyIiwiX3RhcmdldCI6IklkZW50aXR5UHJvdmlkZXJSU1VFIn0.QM_iK7LK5KnXhMwueRhBDNO2M8nS1fNUBsJ7p0LMBGI8xDnwmv987y6CmBr1BiXzKGgyxFpQwTLy84rF9b_PyTl8vKrEtLFz83oMEqwlQ4_P_2dKEj53pAHpvfRVFbeXerImf7IGeYMfUdw2H78jXyj_ekK5Cykb3uGlCPmfBgtmI-C8m8Ju3Gn6KGdmAq0neJuddG04GNgYXhsWsDN_lF9YbCJI-RxuuIJmZTyXTDKhh2Scc319MPYZdAPiTBzz-kOOIq0pHAPAYIQT3OdBumiRW55ughr97_emdjzrIVZLK942ShJFAVS5Ou8gCkulQZ9DBcPbaKScIzKBrw_YBQ"
const Client_ID = "9de0efb9-767e-453b-84fa-a3b0d76c97be"
const Client_Secret = "MOUO38WXiSPeNHNwZmpo234SwNJZvxWopKZmX9XuE1anK1Qpd_RyLDOlJQSP_qxahf-ewCjxRWYhMcola2egpg"

var (
	key *siam.PublicKey
	jwt siam.Jwt
)

// this function shows how to use and validat a access token
func main() {
	var ok error
	if key, ok = siam.GetPublicKey(); ok != nil {
		panic("Can't get SIAM public keys")
	}

	if jwt, ok = siam.DecodeJWT(jwtRaw); ok != nil {
		panic(ok)
	}

	if ok = jwt.VerifySignature(key); ok == nil {
		fmt.Println("Your SIAM JWT access token is signed correct")
	} else {
		fmt.Printf("You SIAM JWT access token is not valid. Error was '%s'\n", ok)
	}

	//fake a still valid one for test reasons
	jwt.Payload.Exp = time.Now().Unix() + 10*60

	if ok = jwt.ValidatePayload(); ok == nil {
		fmt.Println("Your SIAM JWT access token has just valid attributes")
	} else {
		fmt.Printf("You SIAM JWT access token has invalid attributes. Error was '%s'\n", ok)
	}

	user := jwt.GetUser()

	fmt.Printf("Name:\t\t%s\n", user.Name)
	fmt.Printf("Mail:\t\t%s\n", user.Email)
	fmt.Printf("Uid:\t\t%s\n", user.Uid)
	fmt.Printf("a random role:\t%s\n", user.Roles[10])

	fmt.Printf("Has the user the role 'snyk-xx-sit-odj-apienablement-adm'? %v\n", user.HasRole("snyk-xx-sit-odj-apienablement-adm"))

	if ok = jwt.Introspect(); ok != nil {
		fmt.Printf("Access token is not valid any more: %v\n", ok)
	}

	for i := 0; i < 0; i++ {
		time.Sleep(2 * time.Second)
		fmt.Printf("Varify JWT with public key updated at: %v. Pointer to key is %p\n", time.Unix(key.LastUpdate, 0), key)
		if ok = jwt.VerifySignature(key); ok == nil {
			fmt.Println("Your SIAM JWT access token is signed correct")
		} else {
			fmt.Printf("You SIAM JWT access token is not valid. Error was '%s'\n", ok)
		}

	}

}
